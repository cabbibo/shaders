<html>

  <head>
    <style>
      html{margin:0px;background:#000;overflow:hidden;}
      #container{ position:absolute; left:0px; top:0px; }
    </style>
  </head>

  <body>


    <script src="lib/three.min.js"></script>
    <script src="lib/TrackballControls.js"></script>
    
    <script id="vs" type="x-shader/x-vertex">

      attribute vec4 textCoord;
      //attribute vec4 color;

      // varying vec2 vUv;
      varying vec4 vTextCoord;
      varying mat4 vMV;
      void main(){

        //vUv = uv;

        vTextCoord = textCoord;

        vec4 mvPos = modelViewMatrix * vec4( position, 1.0 );
        gl_PointSize = 10000. / length( mvPos );
        gl_Position = projectionMatrix * mvPos;

      }


    </script>
    <script id="fs" type="x-shader/x-fragment">

      uniform vec3 color;
      uniform sampler2D t_text;

      varying vec4 vTextCoord;
      varying mat4 vMV; 
      //varying vec2 vUv;

      const vec2 textSize = vec2( 16. / 512. , 16./256.);

      const float smoothing = 1.0 / 16.0;
      void main(){


       // vec2 newCoord = (1. - vTextCoord.xy ) +  gl_PointCoord;

        vec2 newCoord = vec2( vTextCoord.x ,  vTextCoord.y );
        vec2 sCoord =  newCoord + gl_PointCoord * vec2( .05 , .1 );

        float distance = texture2D(t_text , sCoord ).g;
        float lum = smoothstep( 0.5 - smoothing , 0.5 + smoothing , distance );
        float alpha = 1. - lum;
        gl_FragColor = vec4( color* vec3( gl_PointCoord , 1.0 ) , alpha );





      }

    </script>

    <script>

      var letterIndicies = {

        A:[  1 , 2 ],
        B:[  2 , 2 ],
        C:[  3 , 2 ],
        D:[  4 , 2 ],
        E:[  5 , 2 ],
        F:[  6 , 2 ],
        G:[  7 , 2 ],
        H:[  8 , 2 ],
        I:[  9 , 2 ],
        J:[ 10 , 2 ],
        K:[ 11 , 2 ],
        L:[ 12 , 2 ],
        M:[ 13 , 2 ],
        N:[ 14 , 2 ],
        O:[ 15 , 2 ],
        P:[  0 , 3 ],
        Q:[  1 , 3 ],
        R:[  2 , 3 ],
        S:[  3 , 3 ],
        T:[  4 , 3 ],
        U:[  5 , 3 ],
        V:[  6 , 3 ],
        W:[  7 , 3 ],
        X:[  8 , 3 ],
        Y:[  9 , 3 ],
        Z:[ 10 , 3 ],
        a:[  1 , 4 ],
        b:[  2 , 4 ],
        c:[  3 , 4 ],
        d:[  4 , 4 ],
        e:[  5 , 4 ],
        f:[  6 , 4 ],
        g:[  7 , 4 ],
        h:[  8 , 4 ],
        i:[  9 , 4 ],
        j:[ 10 , 4 ],
        k:[ 11 , 4 ],
        l:[ 12 , 4 ],
        m:[ 13 , 4 ],
        n:[ 14 , 4 ],
        o:[ 15 , 4 ],
        p:[  0 , 5 ],
        q:[  1 , 5 ],
        r:[  2 , 5 ],
        s:[  3 , 5 ],
        t:[  4 , 5 ],
        u:[  5 , 5 ],
        v:[  6 , 5 ],
        w:[  7 , 5 ],
        x:[  8 , 5 ],
        y:[  9 , 5 ],
        z:[ 10 , 5 ],

        period: [ 14 , 0 ],
        comma:  [ 12 , 0 ]

      }

      var string = "Hello friends. My name is Isaac, I have here to be your friend on the internet yes thank you Can we please be friends that would be so delightful and wonderful. I would love ti more thatn anythign . Hello friends. My name is Isaac, I have here to be your friend on the internet yes thank you Can we please be friends that would be so delightful and wonderful. I would love ti more thatn anythign .  ";
      
      var uniforms;
      var texture;
      var camera, renderer, scene , controls;
      
      var vs, fs;

      var geometry, material , light;


      var particles;

      init();
      animate();
      function init(){

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , 1 , 2000 );
        camera.position.z = 100;

        controls = new THREE.TrackballControls( camera );
        scene = new THREE.Scene();

        texture = THREE.ImageUtils.loadTexture('img/signDistance.png');
        texture.flipY = false;

        particles = initParticles( document.getElementById('fs').textContent );

        geometry = new THREE.BufferGeometry();

		geometry.addAttribute( 'position', Float32Array, particles.length , 3 );
		geometry.addAttribute( 'textCoord', Float32Array, particles.length, 4 );

  	    var positions = geometry.attributes.position.array;
  	    var textCoords = geometry.attributes.textCoord.array;
  	    //var textCoords = geometry.attributes.color.array;
        

        var size = 10;
        for( var i = 0; i < particles.length; i++ ){
        
         

          positions[ i * 3 + 0 ] = particles[i][1] * size;
          positions[ i * 3 + 1 ] = -particles[i][2] * size * 1.1; 
          positions[ i * 3 + 2 ] = 0; 

          tc = getTextCoordinates( particles[i][0] );


          textCoords[ i * 4 + 0 ] = tc[0];
          textCoords[ i * 4 + 1 ] = tc[1];
          textCoords[ i * 4 + 2 ] = tc[2];
          textCoords[ i * 4 + 3 ] = tc[3];

        }
        uniforms = {

          t_text:{ type:"t" , value: texture },
          color:{ type:"c" , value:new THREE.Color( 0xc0ffee ) },
      
        }
        
        vs = document.getElementById('vs').textContent;
        fs = document.getElementById('fs').textContent;

        var attributes = {

          textCoord: { type:"v4" , value: null }

        }
        material = new THREE.ShaderMaterial({

          uniforms:uniforms,
          attributes: attributes,
          vertexShader: vs,
          fragmentShader: fs,
          transparent: true,
          depthWrite: false,
          blending:THREE.AdditiveBlending

        });
       
        ps = new THREE.ParticleSystem( geometry, material );
        scene.add( ps );

        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );

        document.body.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onResize , false );


      }

      function animate(){

        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene , camera );
      }

      function onResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      function initParticles(string , width , lineWidth ){


        var lineArray = string.split("\n");
       // var wordArray = string.split(" ");
        var particles  = [];

        var maxWidth = 200;

        var counter = [0,0];

        for( var i = 0; i < lineArray.length; i++ ){

          counter[0] = 0;
          counter[1] ++;

          var wordArray = lineArray[i].split(" ");

          for( var j = 0; j < wordArray.length; j++ ){

            var word = wordArray[j];
            var letters = word.split("");
            var l = letters.length;
            console.log( counter[0] + l );

            var newL = counter[0] + l;
            if( newL > maxWidth ){
              counter[0] = 0;
              counter[1] ++;
            }

            for( var k = 0; k < letters.length; k ++ ){

              particles.push( [letters[k] , counter[0] , counter[1]] );
              counter[0] ++;

            }

            counter[0] ++;

          }

        }


        return particles;
      }


      function getTextCoordinates( letter ){

        var index;
        
        for( var l in letterIndicies ){

          if( letter == '.' ){ letter = 'period'; console.log('hwos')}

          if( letter == ',' ) letter = 'comma';
          if( l == letter )
            index = letterIndicies[l];  
        }

        if( !index )
          index = [0,0];

        var left = (32 * (index[0]) ) / 512; 
        var top  = (32 * (index[1]) ) / 256;

        var bottom = top + ( 16 / 512 );
        var right = left + ( 16 / 512 );

        var array = [ left , top , bottom , right ];
        return array
      }
    </script>

  </body>
</html>
